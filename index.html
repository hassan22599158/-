<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø­Ø±Ùƒ Ø§Ù„Ø´Ø·Ø±Ù†Ø¬ Ø§Ù„Ø®Ø¨ÙŠØ± - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø§Ù„Ù…Ø³ØªÙ‚Ø±</title>
    
    <link rel="stylesheet" href="css/chessboard-1.0.0.min.css">
    <script src="js/jquery-3.5.1.min.js"></script>
    <script src="js/chessboard-1.0.0.min.js"></script>
    <script src="js/chess.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        /* CSS styles remain the same */
        :root { --primary-color: #0d6efd; --success-color: #198754; --warning-color: #ffc107; --danger-color: #dc3545; --info-color: #0dcaf0; --orange-color: #fd7e14; --light-bg: #f8f9fa; --dark-text: #212529; --muted-text: #6c757d; --card-bg: #ffffff; --modal-bg: #ffffff; --border-radius-lg: 16px; --border-radius-md: 8px; --shadow-strong: 0 8px 24px rgba(0, 0, 0, 0.15); --shadow-light: 0 4px 12px rgba(0, 0, 0, 0.08); --font-family-main: 'Cairo', sans-serif; }
        body { font-family: var(--font-family-main); direction: rtl; text-align: right; background-color: var(--light-bg); color: var(--dark-text); margin: 0; padding: 2rem; line-height: 1.7; }
        .container { max-width: 1400px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 2rem; border-bottom: 1px solid #dee2e6; padding-bottom: 1.5rem; }
        header h1 { font-weight: 900; font-size: 3rem; color: var(--primary-color); }
        header p { font-size: 1.25rem; color: var(--muted-text); }
        .main-layout { display: grid; grid-template-columns: 1fr 450px; gap: 2rem; align-items: flex-start; }
        @media (max-width: 1200px) { .main-layout { grid-template-columns: 1fr; } }
        .card { background-color: var(--card-bg); border-radius: var(--border-radius-lg); box-shadow: var(--shadow-light); padding: 1.5rem 2rem; margin-bottom: 1.5rem; }
        .card-header { font-size: 1.5rem; font-weight: 700; color: var(--primary-color); margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid #eee; }
        #mainBoard { width: 100%; max-width: 700px; margin: 0 auto; box-shadow: var(--shadow-strong); border-radius: var(--border-radius-md); }
        .highlight-selected { box-shadow: inset 0 0 3px 3px var(--orange-color) !important; }
        .highlight-legal { background: radial-gradient(circle, rgba(20, 85, 30, 0.5) 25%, transparent 30%); }
        .game-status { text-align: center; font-size: 1.2rem; font-weight: 700; padding: 1rem; border-radius: var(--border-radius-md); background-color: #e9ecef; }
        .controls-panel .btn { display: block; width: 100%; padding: 0.75rem 1rem; font-size: 1.1rem; font-weight: 700; margin-bottom: 0.75rem; cursor: pointer; border: none; border-radius: var(--border-radius-md); transition: all 0.2s ease; }
        .btn-primary { background-color: var(--primary-color); color: white; } .btn-primary:hover { background-color: #0b5ed7; }
        .btn-danger { background-color: var(--danger-color); color: white; } .btn-danger:hover { background-color: #b02a37; }
        .pgn-container { font-family: monospace, sans-serif; text-align: left; direction: ltr; background-color: #e9ecef; padding: 1rem; border-radius: var(--border-radius-md); height: 200px; overflow-y: scroll; line-height: 1.5; border: 1px solid #ccc; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0s 0.3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; transition: opacity 0.3s ease; }
        .modal-content { background-color: var(--modal-bg); padding: 2.5rem; border-radius: var(--border-radius-lg); width: 90%; max-width: 650px; box-shadow: var(--shadow-strong); transform: scale(0.9); transition: transform 0.3s ease; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-header { display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid; }
        .modal-header .icon { font-size: 2.5rem; } .modal-header .title { font-size: 1.8rem; font-weight: 700; }
        .modal-header.excellent { border-color: var(--success-color); color: var(--success-color); } .modal-header.good { border-color: var(--info-color); color: var(--info-color); }
        .modal-header.inaccuracy { border-color: var(--warning-color); color: var(--warning-color); } .modal-header.mistake { border-color: var(--orange-color); color: var(--orange-color); }
        .modal-header.blunder { border-color: var(--danger-color); color: var(--danger-color); }
        .modal-body h3 { font-size: 1.2rem; font-weight: 700; color: var(--dark-text); margin-top: 1.5rem; margin-bottom: 0.5rem; }
        .modal-body .explanation { background-color: #f8f9fa; padding: 1rem; border-radius: var(--border-radius-md); border-right: 5px solid; }
        .modal-footer { text-align: center; margin-top: 2rem; } .modal-footer .btn-close { background-color: var(--muted-text); color: white; padding: 0.75rem 2.5rem; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Ù…Ø­Ø±Ùƒ Ø§Ù„Ø´Ø·Ø±Ù†Ø¬ Ø§Ù„Ø®Ø¨ÙŠØ±</h1>
            <p>Ø­Ù„Ù„ ÙƒÙ„ Ù†Ù‚Ù„Ø©ØŒ ØªØ¹Ù„Ù… Ø§Ù„Ù…Ø¨Ø§Ø¯Ø¦ØŒ ÙˆØ§Ø­ØªØ±Ù Ø§Ù„Ø´Ø·Ø±Ù†Ø¬</p>
        </header>
        <main class="main-layout">
            <div class="game-area-container"><div class="card"><div id="mainBoard"></div></div><div id="gameStatus" class="game-status"></div></div>
            <aside class="info-panel"><div class="card"><h2 class="card-header">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2><div class="controls-panel"><button id="startBtn" class="btn btn-primary">Ø§Ø¨Ø¯Ø£ Ù„Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©</button><button id="undoBtn" class="btn btn-danger">ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ø§Ù„Ù†Ù‚Ù„Ø©</button></div></div><div class="card"><h2 class="card-header">Ø³Ø¬Ù„ Ø§Ù„Ù†Ù‚Ù„Ø§Øª (PGN)</h2><div id="pgn" class="pgn-container"></div></div></aside>
        </main>
    </div>
    <div id="feedbackModal" class="modal-overlay"><div class="modal-content"><div id="modalHeader" class="modal-header"><span id="modalIcon" class="icon"></span><span id="modalTitle" class="title"></span></div><div id="modalBody" class="modal-body"><div><h3>Ø´Ø±Ø­ Ø§Ù„Ù†Ù‚Ù„Ø©:</h3><div id="moveExplanation" class="explanation"></div></div><div><h3>Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ù…Ø·Ø¨Ù‚Ø© / Ø§Ù„Ù…Ù‡Ù…Ù„Ø©:</h3><div id="principleExplanation" class="explanation"></div></div><div><h3>Ø§Ù„Ù†Ù‚Ù„Ø© Ø§Ù„Ø£ÙØ¶Ù„ Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©:</h3><div id="suggestionExplanation" class="explanation"></div></div></div><div class="modal-footer"><button id="closeModalBtn" class="btn btn-close">ÙÙ‡Ù…ØªØŒ Ø£ÙƒÙ…Ù„ Ø§Ù„Ù„Ø¹Ø¨</button></div></div></div>
    <div id="tipModal" class="modal-overlay"><div class="modal-content"><div id="tipModalHeader" class="modal-header good"><span class="icon">ğŸ’¡</span><span class="title">Ù†ØµÙŠØ­Ø© Ù…Ø§ Ù‚Ø¨Ù„ Ø§Ù„Ù„Ø¹Ø¨Ø©</span></div><div id="tipModalBody" class="modal-body"><p id="tipText" style="font-size: 1.2rem;"></p></div><div class="modal-footer"><button id="closeTipModalBtn" class="btn btn-close">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨</button></div></div></div>

    <script>
    // ==========================================================================
    // SECTION 1: KNOWLEDGE BASE AND DATA
    // ==========================================================================

    const gameTips = [
        "ØªØ°ÙƒØ±: Ø§Ù„Ø³ÙŠØ·Ø±Ø© Ø¹Ù„Ù‰ Ù…Ø±ÙƒØ² Ø§Ù„Ø±Ù‚Ø¹Ø© Ù‡ÙŠ Ù…ÙØªØ§Ø­ Ø§Ù„ÙÙˆØ² ÙÙŠ Ø§Ù„Ø§ÙØªØªØ§Ø­.",
        "Ù„Ø§ ØªØ®Ø±Ø¬ ÙˆØ²ÙŠØ±Ùƒ Ù…Ø¨ÙƒØ±Ø§Ù‹ Ø¬Ø¯Ø§Ù‹ØŒ ÙÙ‚Ø¯ ÙŠØµØ¨Ø­ Ù‡Ø¯ÙØ§Ù‹ Ù„Ù‚Ø·Ø¹ Ø®ØµÙ…Ùƒ.",
        "Ù‚Ù… Ø¨Ø§Ù„ØªØ¨ÙŠÙŠØª ÙÙŠ Ø£Ù‚Ø±Ø¨ ÙØ±ØµØ© Ù…Ù…ÙƒÙ†Ø© Ù„ØªØ£Ù…ÙŠÙ† Ù…Ù„ÙƒÙƒ.",
        "Ù‚Ø¨Ù„ ÙƒÙ„ Ù†Ù‚Ù„Ø©ØŒ Ø§Ø³Ø£Ù„ Ù†ÙØ³Ùƒ: Ù…Ø§ Ù‡Ùˆ ØªÙ‡Ø¯ÙŠØ¯ Ø®ØµÙ…ÙŠØŸ",
        "Ø§Ù„Ù‚Ø·Ø¹Ø© ØºÙŠØ± Ø§Ù„Ù…Ø·ÙˆØ±Ø© Ù‡ÙŠ Ù‚Ø·Ø¹Ø© Ø¹Ø¯ÙŠÙ…Ø© Ø§Ù„ÙØ§Ø¦Ø¯Ø©. Ø·ÙˆØ± ÙƒÙ„ Ù‚Ø·Ø¹Ùƒ.",
        "Ø§Ù„Ø´ÙˆÙƒØ© Ø¨Ø§Ù„Ø­ØµØ§Ù† Ù‡ÙŠ Ø£Ø­Ø¯ Ø£Ù‚ÙˆÙ‰ Ø§Ù„ØªÙƒØªÙŠÙƒØ§Øª. Ø§Ø¨Ø­Ø« Ø¹Ù†Ù‡Ø§ Ø¯Ø§Ø¦Ù…Ø§Ù‹.",
        "ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù„Ø¹Ø¨Ø©ØŒ Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ù„Ùƒ Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø£Ù‡Ù… Ù…Ù† Ø§Ù„Ù…ÙˆØ§Ø¯.",
        "Ù„Ø§ ØªÙ‚Ù… Ø¨Ø­Ø±ÙƒØ§Øª Ø¨ÙŠØ§Ø¯Ù‚ Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©ØŒ ÙÙƒÙ„ Ø­Ø±ÙƒØ© Ø¨ÙŠØ¯Ù‚ ØªØ®Ù„Ù‚ Ø¶Ø¹ÙØ§Ù‹ Ø¯Ø§Ø¦Ù…Ø§Ù‹.",
        "Ø§Ù„Ù‚Ù„Ø¹Ø© ØªÙƒÙˆÙ† ÙÙŠ Ø£Ù‚ØµÙ‰ Ù‚ÙˆØªÙ‡Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…ÙØªÙˆØ­Ø© ÙˆØ§Ù„ØµÙÙˆÙ Ø§Ù„Ø³Ø§Ø¨Ø¹Ø©.",
        "Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ø¯ÙŠÙƒ ÙÙŠÙ„ Ø³ÙŠØ¡ØŒ Ø­Ø§ÙˆÙ„ ØªØ¨Ø¯ÙŠÙ„Ù‡ Ø¨ÙÙŠÙ„ Ø®ØµÙ…Ùƒ Ø§Ù„Ø¬ÙŠØ¯ Ø£Ùˆ Ø­ØµØ§Ù†Ù‡."
    ];

    const chessPrinciples = {
        'BLUNDER_HANGING_PIECE': { id: 'BLUNDER_HANGING_PIECE', name: 'Ø®Ø·Ø£ ÙØ§Ø¯Ø­ - Ù‚Ø·Ø¹Ø© Ù…ØªØ±ÙˆÙƒØ©', priority: 100, description: 'Ù„Ù‚Ø¯ ØªØ±ÙƒØª Ø¥Ø­Ø¯Ù‰ Ù‚Ø·Ø¹Ùƒ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø¨Ø¯ÙˆÙ† Ø­Ù…Ø§ÙŠØ© ÙƒØ§ÙÙŠØ©ØŒ ÙˆÙŠÙ…ÙƒÙ† Ù„Ù„Ø®ØµÙ… Ø£Ø®Ø°Ù‡Ø§ Ø§Ù„Ø¢Ù†. Ù‡Ø°Ø§ Ù‡Ùˆ Ø£Ø³ÙˆØ£ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ù„Ø£Ù†Ù‡ ÙŠØºÙŠØ± Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© ÙÙˆØ±Ù‹Ø§.', check: (m, g) => isPieceHanging(m.to, g) },
        'BLUNDER_MATE_IN_ONE': { id: 'BLUNDER_MATE_IN_ONE', name: 'Ø®Ø·Ø£ ÙØ§Ø¯Ø­ - ØªÙÙˆÙŠØª ÙƒØ´ Ù…Ù„Ùƒ', priority: 200, description: 'ÙƒØ§Ù† Ù„Ø¯ÙŠÙƒ ÙØ±ØµØ© Ù„Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© Ø¨ÙƒØ´ Ù…Ù„Ùƒ ÙÙŠ Ù†Ù‚Ù„Ø© ÙˆØ§Ø­Ø¯Ø©ØŒ Ù„ÙƒÙ†Ùƒ Ù„Ù… ØªÙ†ØªØ¨Ù‡ Ù„Ù‡Ø§! Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© Ù‡Ùˆ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„Ù‚ØµÙˆÙ‰.', check: (m, g) => wasMateInOneAvailable(g) },
        'ENDGAME_ROOK_ON_7TH': { id: 'ENDGAME_ROOK_ON_7TH', name: 'Ù‚Ù„Ø¹Ø© ÙÙŠ Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¨Ø¹', priority: 45, description: 'ÙˆØ¶Ø¹ Ù‚Ù„Ø¹ØªÙƒ ÙÙŠ Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¨Ø¹ Ù„Ù„Ø®ØµÙ… Ù‡Ùˆ Ø­Ø±ÙƒØ© Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ù‚ÙˆÙŠØ© Ø¬Ø¯Ù‹Ø§ØŒ ÙÙ‡ÙŠ ØªÙ‡Ø¯Ø¯ Ø¨ÙŠØ§Ø¯Ù‚Ù‡ØŒ ÙˆØªÙ‚ÙŠØ¯ Ø­Ø±ÙƒØ© Ù…Ù„ÙƒÙ‡ØŒ ÙˆØªØ®Ù„Ù‚ ÙØ±Øµ Ù‡Ø¬ÙˆÙ…ÙŠØ© Ø­Ø§Ø³Ù…Ø©.', check: (m, g) => m.piece === 'r' && isEndgame(g) && ((m.color === 'w' && m.to.includes('7')) || (m.color === 'b' && m.to.includes('2'))) },
        'ENDGAME_ACTIVATE_KING': { id: 'ENDGAME_ACTIVATE_KING', name: 'ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ù„Ùƒ ÙÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©', priority: 40, description: 'ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù„Ø¹Ø¨Ø©ØŒ ÙŠØªØ­ÙˆÙ„ Ø§Ù„Ù…Ù„Ùƒ Ù…Ù† Ù‚Ø·Ø¹Ø© ØªØ­ØªØ§Ø¬ Ù„Ù„Ø­Ù…Ø§ÙŠØ© Ø¥Ù„Ù‰ Ù‚Ø·Ø¹Ø© Ù‡Ø¬ÙˆÙ…ÙŠØ© Ù‚ÙˆÙŠØ©. Ø¥Ø­Ø¶Ø§Ø±Ù‡ Ø¥Ù„Ù‰ ÙˆØ³Ø· Ø§Ù„Ø±Ù‚Ø¹Ø© Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ© ÙÙŠ Ø§Ù„Ù‚ØªØ§Ù„ Ù‡Ùˆ Ù‚Ø±Ø§Ø± ØµØ§Ø¦Ø¨.', check: (m, g) => m.piece === 'k' && isEndgame(g) },
        'MISTAKE_WEAKEN_KING_PAWN_F': { id: 'MISTAKE_WEAKEN_KING_PAWN_F', name: 'Ø¥Ø¶Ø¹Ø§Ù Ø¨ÙŠØ¯Ù‚ Ø§Ù„Ù…Ù„Ùƒ (f)', priority: 30, description: 'ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø¨ÙŠØ¯Ù‚ f (f2/f7) Ù…Ø¨ÙƒØ±Ø§Ù‹ØŒ Ø®Ø§ØµØ© Ù‚Ø¨Ù„ Ø§Ù„ØªØ¨ÙŠÙŠØªØŒ ÙŠÙƒØ´Ù Ù…Ù„ÙƒÙƒ Ø¨Ø´ÙƒÙ„ Ø®Ø·ÙŠØ± ÙˆÙŠÙØªØ­ Ø£Ù‚Ø·Ø§Ø±Ù‹Ø§ Ø­ÙŠÙˆÙŠØ© Ù„Ù‡Ø¬ÙˆÙ… Ø§Ù„Ø®ØµÙ…. ØªØ¬Ù†Ø¨ Ù‡Ø°Ø§ Ø§Ù„Ø®Ø·Ø£ Ø§Ù„Ø´Ø§Ø¦Ø¹.', check: (m, g) => m.piece === 'p' && m.from.includes('f') && g.history().length < 10 },
        'GOOD_IMPROVE_WORST_PIECE': { id: 'GOOD_IMPROVE_WORST_PIECE', name: 'ØªØ­Ø³ÙŠÙ† Ø£Ø³ÙˆØ£ Ù‚Ø·Ø¹Ø©', priority: 25, description: 'Ù†Ù‚Ù„Ø© Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø¹Ù…ÙŠÙ‚Ø©. Ù„Ù‚Ø¯ Ø­Ø¯Ø¯Øª Ø§Ù„Ù‚Ø·Ø¹Ø© Ø§Ù„Ø£Ù‚Ù„ ÙØ§Ø¹Ù„ÙŠØ© Ù„Ø¯ÙŠÙƒ ÙˆÙ†Ù‚Ù„ØªÙ‡Ø§ Ø¥Ù„Ù‰ Ù…Ø±Ø¨Ø¹ Ø£ÙØ¶Ù„ØŒ Ù…Ù…Ø§ ÙŠØ²ÙŠØ¯ Ù…Ù† Ù‚ÙˆØ© Ø¬ÙŠØ´Ùƒ Ø¨Ø´ÙƒÙ„ Ø¹Ø§Ù….', check: (m, g) => false }, // Requires complex check
        'MISTAKE_QUEEN_TOO_EARLY': { id: 'MISTAKE_QUEEN_TOO_EARLY', name: 'Ø¥Ø®Ø±Ø§Ø¬ Ø§Ù„ÙˆØ²ÙŠØ± Ù…Ø¨ÙƒØ±Ø§Ù‹', priority: 20, description: 'Ø¥Ø®Ø±Ø§Ø¬ Ø§Ù„ÙˆØ²ÙŠØ± ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù„Ø¹Ø¨Ø© ÙŠØ¬Ø¹Ù„Ù‡ Ù‡Ø¯ÙØ§Ù‹ Ø³Ù‡Ù„Ø§Ù‹ Ù„Ù‚Ø·Ø¹ Ø§Ù„Ø®ØµÙ…. Ù‡Ø°Ø§ ÙŠØ¬Ø¨Ø±Ùƒ Ø¹Ù„Ù‰ Ø¥Ø¶Ø§Ø¹Ø© Ù†Ù‚Ù„Ø§Øª ÙÙŠ ØªØ­Ø±ÙŠÙƒÙ‡ ÙˆÙŠÙ‡Ø¯ÙŠ Ø®ØµÙ…Ùƒ "ØªÙ…Ø¨Ùˆ" Ù…Ø¬Ø§Ù†ÙŠÙ‹Ø§ Ù„Ù„ØªØ·ÙˆÙŠØ±.', check: (m, g) => m.piece === 'q' && g.history().length < 8 },
        'MISTAKE_BAD_PAWN_STRUCTURE': { id: 'MISTAKE_BAD_PAWN_STRUCTURE', name: 'Ø¥Ø¶Ø¹Ø§Ù Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ø¯Ù‚', priority: 18, description: 'Ù‡Ø°Ù‡ Ø§Ù„Ù†Ù‚Ù„Ø© Ø£Ø¯Øª Ø¥Ù„Ù‰ Ø¶Ø¹Ù ÙÙŠ Ù‡ÙŠÙƒÙ„ Ø¨ÙŠØ§Ø¯Ù‚Ùƒ (Ù…Ø«Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ¯Ù‚ Ù…Ø¹Ø²ÙˆÙ„ Ø£Ùˆ Ù…Ø¶Ø§Ø¹Ù)ØŒ Ù…Ù…Ø§ Ù‚Ø¯ ÙŠØµØ¨Ø­ Ù‡Ø¯ÙÙ‹Ø§ Ù„Ù„Ø®ØµÙ… Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¯Ù‰ Ø§Ù„Ø·ÙˆÙŠÙ„.', check: (m, g) => false }, // Requires complex check
        'MISTAKE_MOVE_SAME_PIECE': { id: 'MISTAKE_MOVE_SAME_PIECE', name: 'ØªØ­Ø±ÙŠÙƒ Ù†ÙØ³ Ø§Ù„Ù‚Ø·Ø¹Ø© Ù…Ø±ØªÙŠÙ†', priority: 15, description: 'ÙÙŠ Ø§Ù„Ø§ÙØªØªØ§Ø­ØŒ ÙƒÙ„ Ù†Ù‚Ù„Ø© Ø«Ù…ÙŠÙ†Ø©. ØªØ­Ø±ÙŠÙƒ Ù†ÙØ³ Ø§Ù„Ù‚Ø·Ø¹Ø© Ù…Ø±ØªÙŠÙ† ÙŠØ¹Ù†ÙŠ Ø£Ù†Ùƒ Ø£Ù‡Ù…Ù„Øª ØªØ·ÙˆÙŠØ± Ù‚Ø·Ø¹Ø© Ø£Ø®Ø±Ù‰. Ø§Ù„Ù‡Ø¯Ù Ù‡Ùˆ Ù†Ø´Ø± ÙƒÙ„ Ø§Ù„Ù‚Ø·Ø¹ Ø¨Ø£Ø³Ø±Ø¹ ÙˆÙ‚Øª.', check: (m, g, h) => g.history().length < 10 && h.filter(hm => hm.color === m.color && hm.piece === m.piece).length > 1 },
        'MISTAKE_UNNECESSARY_PAWN_MOVE': { id: 'MISTAKE_UNNECESSARY_PAWN_MOVE', name: 'Ø­Ø±ÙƒØ© Ø¨ÙŠØ¯Ù‚ ØºÙŠØ± Ø¶Ø±ÙˆØ±ÙŠØ©', priority: 12, description: 'Ø±ÙƒØ² Ø¹Ù„Ù‰ ØªØ·ÙˆÙŠØ± Ø§Ù„Ù‚Ø·Ø¹ (Ø§Ù„Ø£Ø­ØµÙ†Ø© ÙˆØ§Ù„ÙÙŠÙ„Ø©) ÙˆØ§Ù„Ø³ÙŠØ·Ø±Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø±ÙƒØ² Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† ØªØ­Ø±ÙŠÙƒ Ø¨ÙŠØ§Ø¯Ù‚ Ø§Ù„Ø£Ø¬Ù†Ø­Ø© (a, b, g, h) Ø¨Ø¯ÙˆÙ† Ø¯Ø§Ø¹Ù ÙÙŠ Ø§Ù„Ø§ÙØªØªØ§Ø­.', check: (m, g) => m.piece === 'p' && g.history().length < 8 && (m.from.includes('a') || m.from.includes('h')) },
        'OPENING_CASTLE_EARLY': { id: 'OPENING_CASTLE_EARLY', name: 'Ø§Ù„ØªØ¨ÙŠÙŠØª Ø§Ù„Ù…Ø¨ÙƒØ±', priority: 10, description: 'Ù…Ù…ØªØ§Ø²! Ø§Ù„ØªØ¨ÙŠÙŠØª Ù‡Ùˆ Ø£Ù‡Ù… Ù†Ù‚Ù„Ø© Ø¯ÙØ§Ø¹ÙŠØ© ÙÙŠ Ø§Ù„Ø§ÙØªØªØ§Ø­. Ù„Ù‚Ø¯ Ø£Ù…Ù†Øª Ù…Ù„ÙƒÙƒ ÙˆØ£Ø¯Ø®Ù„Øª Ù‚Ù„Ø¹ØªÙƒ ÙÙŠ Ø§Ù„Ù„Ø¹Ø¨ ÙÙŠ Ù†Ù‚Ù„Ø© ÙˆØ§Ø­Ø¯Ø©.', check: (m, g) => m.flags.includes('k') || m.flags.includes('q') },
        'OPENING_CENTER_CONTROL': { id: 'OPENING_CENTER_CONTROL', name: 'Ø§Ù„Ø³ÙŠØ·Ø±Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø±ÙƒØ²', priority: 10, description: 'Ù†Ù‚Ù„Ø© Ù‚ÙˆÙŠØ©! Ø§Ù„Ø³ÙŠØ·Ø±Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø±Ø¨Ø¹Ø§Øª Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ© (e4, d4, e5, d5) Ù‡ÙŠ Ù…ÙØªØ§Ø­ Ø§Ù„ÙÙˆØ² ÙÙŠ Ø§Ù„Ø§ÙØªØªØ§Ø­ Ù„Ø£Ù†Ù‡Ø§ ØªÙ…Ù†Ø­ Ù‚Ø·Ø¹Ùƒ Ø£ÙƒØ¨Ø± Ù‚Ø¯Ø± Ù…Ù† Ø§Ù„Ø­Ø±ÙƒØ© ÙˆØ§Ù„ØªØ£Ø«ÙŠØ±.', check: (m, g) => (m.piece === 'p' && (m.to.includes('4') || m.to.includes('5'))) && (m.to.includes('e') || m.to.includes('d')) },
        'OPENING_DEVELOP_KNIGHTS': { id: 'OPENING_DEVELOP_KNIGHTS', name: 'ØªØ·ÙˆÙŠØ± Ø§Ù„Ø£Ø­ØµÙ†Ø©', priority: 9, description: 'ØªØ·ÙˆÙŠØ± Ù…Ø«Ø§Ù„ÙŠ. Ù…Ù† Ø§Ù„Ø£ÙØ¶Ù„ ØªØ·ÙˆÙŠØ± Ø§Ù„Ø£Ø­ØµÙ†Ø© Ù‚Ø¨Ù„ Ø§Ù„ÙÙŠÙ„Ø© Ù„Ø£Ù†Ù‡Ø§ Ø£Ù‚Ù„ ØªÙ‚ÙŠØ¯Ù‹Ø§ Ø¨Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ø¯Ù‚ ÙˆÙŠÙ…ÙƒÙ†Ù‡Ø§ Ø§Ù„Ù‚ÙØ² ÙÙˆÙ‚ Ø§Ù„Ù‚Ø·Ø¹ Ø§Ù„Ø£Ø®Ø±Ù‰.', check: (m, g) => m.piece === 'n' },
        'OPENING_DEVELOP_BISHOPS': { id: 'OPENING_DEVELOP_BISHOPS', name: 'ØªØ·ÙˆÙŠØ± Ø§Ù„ÙÙŠÙ„Ø©', priority: 8, description: 'Ø¬ÙŠØ¯ Ø¬Ø¯Ù‹Ø§. Ù„Ù‚Ø¯ Ø·ÙˆØ±Øª ÙÙŠÙ„Ùƒ ÙˆÙˆØ¶Ø¹ØªÙ‡ ÙÙŠ Ù‚Ø·Ø± Ù…ÙØªÙˆØ­ ÙˆÙ†Ø´Ø·.', check: (m, g) => m.piece === 'b' },
    };
    function isEndgame(g) { return g.SQUARES.map(s => g.get(s)).filter(Boolean).length < 14; }
    function isPieceHanging(sq, g) { const p = g.get(sq); if (!p) return false; return g.isAttacked(sq, p.color === 'w' ? 'b' : 'w'); }
    function wasMateInOneAvailable(gameBeforeMove) {
        const moves = gameBeforeMove.moves();
        for (let i = 0; i < moves.length; i++) {
            gameBeforeMove.move(moves[i]);
            if (gameBeforeMove.in_checkmate()) {
                gameBeforeMove.undo();
                return true;
            }
            gameBeforeMove.undo();
        }
        return false;
    }

    // ==========================================================================
    // SECTION 2: CORE GAME LOGIC - REBUILT FOR STABILITY
    // ==========================================================================
    $(document).ready(function() {
        // --- State Variables ---
        let board = null, game = new Chess(), selectedSquare = null, playerColor = 'w', thinking = false;

        // =================================================================================
        // THE NEW, ROBUST CLICK HANDLER - Ø§Ù„Ù…Ø­Ø±Ùƒ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙˆØ§Ù„Ù…Ø³ØªÙ‚Ø± Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†Ù‚Ø±
        // This is the heart of the game's interaction, rebuilt from scratch.
        // =================================================================================
        function handleSquareClick(square) {
            // --- Step 1: Ignore clicks if it's not the player's turn to act. ---
            if (thinking || game.game_over() || game.turn() !== playerColor) {
                return;
            }

            const pieceOnSquare = game.get(square);

            // --- Step 2: Handle the second click (selecting a destination). ---
            if (selectedSquare) {
                // If the player clicks the same square again, deselect it.
                if (square === selectedSquare) {
                    selectedSquare = null;
                    removeHighlights();
                    return;
                }
                
                // If the player clicks another of their own pieces, switch selection.
                if (pieceOnSquare && pieceOnSquare.color === playerColor) {
                    selectedSquare = square;
                    removeHighlights();
                    highlightMoves(square);
                    return;
                }

                // Try to make the move from the selected square to the clicked square.
                const move = game.move({ from: selectedSquare, to: square, promotion: 'q' });
                
                // If the move is illegal, just deselect and do nothing.
                if (move === null) {
                    selectedSquare = null;
                    removeHighlights();
                    return;
                }

                // If the move IS LEGAL, complete the player's turn and trigger the computer.
                selectedSquare = null;
                removeHighlights();
                playerMoveMade(move);
                return;
            }

            // --- Step 3: Handle the first click (selecting a piece). ---
            if (pieceOnSquare && pieceOnSquare.color === playerColor) {
                selectedSquare = square;
                highlightMoves(square);
            }
        }

        // --- Game Flow Functions ---
        function playerMoveMade(move) {
            board.position(game.fen());
            updatePGN();
            updateStatus();
            analyzeAndShowFeedback(move, game.history({ verbose: true }));
            if (!game.game_over()) {
                setTimeout(triggerComputerMove, 500);
            }
        }
        
        function triggerComputerMove() {
            thinking = true;
            updateStatus();
            setTimeout(() => {
                const move = getComputerMove();
                if (move) game.move(move);
                board.position(game.fen());
                thinking = false;
                updateStatus();
                updatePGN();
            }, 250);
        }
        
        function getComputerMove() {
            const moves = game.moves({ verbose: true });
            if (moves.length === 0) return null;
            let bestMove = moves[0], bestValue = -Infinity;
            moves.forEach(m => {
                game.move(m.san);
                const v = -evaluateBoard(game);
                game.undo();
                if (v > bestValue) { bestValue = v; bestMove = m; }
            });
            return bestMove;
        }

        // --- UI and Helper Functions ---
        function highlightMoves(sq) { $(`#mainBoard .square-${sq}`).addClass('highlight-selected'); game.moves({square:sq,verbose:!0}).forEach(m => $(`#mainBoard .square-${m.to}`).addClass('highlight-legal')); }
        function removeHighlights() { $('.square-55d63').removeClass('highlight-selected highlight-legal'); }
        function updateStatus() { let s; const mc=game.turn()==='w'?'Ø§Ù„Ø£Ø¨ÙŠØ¶':'Ø§Ù„Ø£Ø³ÙˆØ¯'; if(game.in_checkmate())s=`Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©ØŒ ÙƒØ´ Ù…Ù„Ùƒ Ù„Ù„ÙØ±ÙŠÙ‚ ${mc}.`;else if(game.in_draw())s='Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©ØŒ ØªØ¹Ø§Ø¯Ù„.';else{s=`Ø¯ÙˆØ± Ø§Ù„ÙØ±ÙŠÙ‚ ${mc} Ù„Ù„Ø¹Ø¨`;if(thinking)s='Ø§Ù„Ù…Ø¯Ø±Ø¨ Ø§Ù„Ø®Ø¨ÙŠØ± ÙŠØ­Ù„Ù„...'} $('#gameStatus').html(s); }
        function updatePGN() { $('#pgn').html(game.pgn()); $('.pgn-container').scrollTop($('.pgn-container')[0].scrollHeight); }
        function evaluateBoard(g) { let t=0; g.SQUARES.forEach(s=>{const p=g.get(s);if(p)t+=getPieceValue(p.type)*(p.color==='w'?1:-1)}); return t; }
        function getPieceValue(p) { return {p:10,n:30,b:30,r:50,q:90,k:900}[p]||0; }
        function closeModal(modalId) { $(`#${modalId}`).removeClass('visible'); }
        
        function analyzeAndShowFeedback(m,h){let p=[],f=null;const g=new Chess(game.fen());g.undo();for(const k in chessPrinciples){const P=chessPrinciples[k];if(P.check(m,g,h)){p.push({...P,triggered:!0})}}p.sort((a,b)=>b.priority-a.priority);if(p.length>0){const t=p[0];if(t.id.startsWith("BLUNDER"))f={type:"blunder",title:"Ø®Ø·Ø£ ÙØ§Ø¯Ø­!",icon:"ğŸ”¥",moveExplanation:`Ø§Ù„Ù†Ù‚Ù„Ø© ${m.san} Ø®Ø·ÙŠØ±Ø© Ø¬Ø¯Ø§!`,principle:t,suggestion:"Ø¯Ø§Ø¦Ù…Ø§ ØªØ­Ù‚Ù‚ Ù…Ù† Ø³Ù„Ø§Ù…Ø© Ù‚Ø·Ø¹Ùƒ."};else if(t.id.startsWith("MISTAKE"))f={type:"mistake",title:"Ø®Ø·Ø£ Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠ",icon:"ğŸ¤”",moveExplanation:`Ø§Ù„Ù†Ù‚Ù„Ø© ${m.san} ØªØ®Ø§Ù„Ù Ù…Ø¨Ø¯Ø£Ù‹ Ù‡Ø§Ù…Ø§Ù‹.`,principle:t,suggestion:"ÙÙƒØ± ÙÙŠ Ø§Ù„Ø¹ÙˆØ§Ù‚Ø¨ Ø·ÙˆÙŠÙ„Ø© Ø§Ù„Ù…Ø¯Ù‰."};else f={type:"excellent",title:"Ù†Ù‚Ù„Ø© Ù…Ù…ØªØ§Ø²Ø©!",icon:"â­",moveExplanation:`Ø£Ø­Ø³Ù†Øª! Ø§Ù„Ù†Ù‚Ù„Ø© ${m.san} ØªØªØ¨Ø¹ Ø£ÙØ¶Ù„ Ø§Ù„Ù…Ù…Ø§Ø±Ø³Ø§Øª.`,principle:t,suggestion:"Ù‡ÙƒØ°Ø§ ÙŠÙ„Ø¹Ø¨ Ø§Ù„Ù…Ø­ØªØ±ÙÙˆÙ†!"}}if(!f)f={type:"good",title:"Ù†Ù‚Ù„Ø© Ù‚ÙŠØ§Ø³ÙŠØ©",icon:"ğŸ˜Š",moveExplanation:`Ø§Ù„Ù†Ù‚Ù„Ø© ${m.san} Ù…Ù†Ø·Ù‚ÙŠØ© ÙˆÙ…Ù‚Ø¨ÙˆÙ„Ø©.`,principle:{name:"Ù„Ø¹Ø¨ Ø¢Ù…Ù†",description:"Ù„Ù… ØªØ±ØªÙƒØ¨ Ø£Ø®Ø·Ø§Ø¡ ÙˆØ§Ø¶Ø­Ø©."},suggestion:"Ø§Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø®Ø·Ø©."};showFeedbackModal(f)}
        function showFeedbackModal(f){const{type:t,title:i,icon:o,moveExplanation:n,principle:p,suggestion:s}=f;$('#modalHeader').removeClass().addClass('modal-header '+t);$('#modalIcon').text(o);$('#modalTitle').text(i);$('#moveExplanation').text(n).css('border-color',getBorderColor(t));if(p){$('#principleExplanation').html(`<strong>${p.name} (Ø§Ù„Ø£Ù‡Ù…ÙŠØ©: ${p.priority||'Ø¹Ø§Ù„ÙŠØ©'})</strong><p>${p.description}</p>`).css('border-color',getBorderColor(t))}else{$('#principleExplanation').text('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ø§Ø¹Ø¯Ø© Ù…Ø¨Ø§Ø´Ø±Ø©.').css('border-color','#ccc')}$('#suggestionExplanation').text(s).css('border-color',getBorderColor(t));$('#feedbackModal').addClass('visible')}
        function getBorderColor(t){return{excellent:'var(--success-color)',good:'var(--info-color)',inaccuracy:'var(--warning-color)',mistake:'var(--orange-color)',blunder:'var(--danger-color)'}[t]||'#ccc'}

        // --- Initialization ---
        function init() {
            board = Chessboard('mainBoard', {
                position: 'start',
                pieceTheme: 'img/{piece}.png',
                onSquareClick: handleSquareClick // Use the new, rebuilt handler
            });
            $(window).resize(board.resize);
            
            $('#startBtn').on('click', function() {
                const randomTip = gameTips[Math.floor(Math.random() * gameTips.length)];
                $('#tipText').text(randomTip);
                $('#tipModal').addClass('visible');
            });
            $('#closeTipModalBtn').on('click', function() {
                closeModal('tipModal');
                game.reset(); board.start(); updateStatus(); $('#pgn').html('');
                selectedSquare = null; removeHighlights(); thinking = false;
            });
            $('#undoBtn').on('click', function() {
                if(thinking) return;
                game.undo(); game.undo(); board.position(game.fen());
                updateStatus(); updatePGN(); selectedSquare = null; removeHighlights();
            });
            $('#closeModalBtn').on('click', () => closeModal('feedbackModal'));

            // Initial setup
            updateStatus();
        }

        init(); // Start the application
    });
    </script>
</body>
</html>
