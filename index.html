<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>محرك الشطرنج الخبير - الإصدار النهائي المستقر</title>
    
    <link rel="stylesheet" href="css/chessboard-1.0.0.min.css">
    <script src="js/jquery-3.5.1.min.js"></script>
    <script src="js/chessboard-1.0.0.min.js"></script>
    <script src="js/chess.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        /* CSS styles remain the same */
        :root { --primary-color: #0d6efd; --success-color: #198754; --warning-color: #ffc107; --danger-color: #dc3545; --info-color: #0dcaf0; --orange-color: #fd7e14; --light-bg: #f8f9fa; --dark-text: #212529; --muted-text: #6c757d; --card-bg: #ffffff; --modal-bg: #ffffff; --border-radius-lg: 16px; --border-radius-md: 8px; --shadow-strong: 0 8px 24px rgba(0, 0, 0, 0.15); --shadow-light: 0 4px 12px rgba(0, 0, 0, 0.08); --font-family-main: 'Cairo', sans-serif; }
        body { font-family: var(--font-family-main); direction: rtl; text-align: right; background-color: var(--light-bg); color: var(--dark-text); margin: 0; padding: 2rem; line-height: 1.7; }
        .container { max-width: 1400px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 2rem; border-bottom: 1px solid #dee2e6; padding-bottom: 1.5rem; }
        header h1 { font-weight: 900; font-size: 3rem; color: var(--primary-color); }
        header p { font-size: 1.25rem; color: var(--muted-text); }
        .main-layout { display: grid; grid-template-columns: 1fr 450px; gap: 2rem; align-items: flex-start; }
        @media (max-width: 1200px) { .main-layout { grid-template-columns: 1fr; } }
        .card { background-color: var(--card-bg); border-radius: var(--border-radius-lg); box-shadow: var(--shadow-light); padding: 1.5rem 2rem; margin-bottom: 1.5rem; }
        .card-header { font-size: 1.5rem; font-weight: 700; color: var(--primary-color); margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid #eee; }
        #mainBoard { width: 100%; max-width: 700px; margin: 0 auto; box-shadow: var(--shadow-strong); border-radius: var(--border-radius-md); }
        .highlight-selected { box-shadow: inset 0 0 3px 3px var(--orange-color) !important; }
        .highlight-legal { background: radial-gradient(circle, rgba(20, 85, 30, 0.5) 25%, transparent 30%); }
        .game-status { text-align: center; font-size: 1.2rem; font-weight: 700; padding: 1rem; border-radius: var(--border-radius-md); background-color: #e9ecef; }
        .controls-panel .btn { display: block; width: 100%; padding: 0.75rem 1rem; font-size: 1.1rem; font-weight: 700; margin-bottom: 0.75rem; cursor: pointer; border: none; border-radius: var(--border-radius-md); transition: all 0.2s ease; }
        .btn-primary { background-color: var(--primary-color); color: white; } .btn-primary:hover { background-color: #0b5ed7; }
        .btn-danger { background-color: var(--danger-color); color: white; } .btn-danger:hover { background-color: #b02a37; }
        .pgn-container { font-family: monospace, sans-serif; text-align: left; direction: ltr; background-color: #e9ecef; padding: 1rem; border-radius: var(--border-radius-md); height: 200px; overflow-y: scroll; line-height: 1.5; border: 1px solid #ccc; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0s 0.3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; transition: opacity 0.3s ease; }
        .modal-content { background-color: var(--modal-bg); padding: 2.5rem; border-radius: var(--border-radius-lg); width: 90%; max-width: 650px; box-shadow: var(--shadow-strong); transform: scale(0.9); transition: transform 0.3s ease; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-header { display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid; }
        .modal-header .icon { font-size: 2.5rem; } .modal-header .title { font-size: 1.8rem; font-weight: 700; }
        .modal-header.excellent { border-color: var(--success-color); color: var(--success-color); } .modal-header.good { border-color: var(--info-color); color: var(--info-color); }
        .modal-header.inaccuracy { border-color: var(--warning-color); color: var(--warning-color); } .modal-header.mistake { border-color: var(--orange-color); color: var(--orange-color); }
        .modal-header.blunder { border-color: var(--danger-color); color: var(--danger-color); }
        .modal-body h3 { font-size: 1.2rem; font-weight: 700; color: var(--dark-text); margin-top: 1.5rem; margin-bottom: 0.5rem; }
        .modal-body .explanation { background-color: #f8f9fa; padding: 1rem; border-radius: var(--border-radius-md); border-right: 5px solid; }
        .modal-footer { text-align: center; margin-top: 2rem; } .modal-footer .btn-close { background-color: var(--muted-text); color: white; padding: 0.75rem 2.5rem; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>محرك الشطرنج الخبير</h1>
            <p>حلل كل نقلة، تعلم المبادئ، واحترف الشطرنج</p>
        </header>
        <main class="main-layout">
            <div class="game-area-container"><div class="card"><div id="mainBoard"></div></div><div id="gameStatus" class="game-status"></div></div>
            <aside class="info-panel"><div class="card"><h2 class="card-header">لوحة التحكم</h2><div class="controls-panel"><button id="startBtn" class="btn btn-primary">ابدأ لعبة جديدة</button><button id="undoBtn" class="btn btn-danger">تراجع عن النقلة</button></div></div><div class="card"><h2 class="card-header">سجل النقلات (PGN)</h2><div id="pgn" class="pgn-container"></div></div></aside>
        </main>
    </div>
    <div id="feedbackModal" class="modal-overlay"><div class="modal-content"><div id="modalHeader" class="modal-header"><span id="modalIcon" class="icon"></span><span id="modalTitle" class="title"></span></div><div id="modalBody" class="modal-body"><div><h3>شرح النقلة:</h3><div id="moveExplanation" class="explanation"></div></div><div><h3>القاعدة المطبقة / المهملة:</h3><div id="principleExplanation" class="explanation"></div></div><div><h3>النقلة الأفضل المقترحة:</h3><div id="suggestionExplanation" class="explanation"></div></div></div><div class="modal-footer"><button id="closeModalBtn" class="btn btn-close">فهمت، أكمل اللعب</button></div></div></div>
    <div id="tipModal" class="modal-overlay"><div class="modal-content"><div id="tipModalHeader" class="modal-header good"><span class="icon">💡</span><span class="title">نصيحة ما قبل اللعبة</span></div><div id="tipModalBody" class="modal-body"><p id="tipText" style="font-size: 1.2rem;"></p></div><div class="modal-footer"><button id="closeTipModalBtn" class="btn btn-close">ابدأ اللعب</button></div></div></div>

    <script>
    // ==========================================================================
    // SECTION 1: KNOWLEDGE BASE AND DATA
    // ==========================================================================

    const gameTips = [
        "تذكر: السيطرة على مركز الرقعة هي مفتاح الفوز في الافتتاح.",
        "لا تخرج وزيرك مبكراً جداً، فقد يصبح هدفاً لقطع خصمك.",
        "قم بالتبييت في أقرب فرصة ممكنة لتأمين ملكك.",
        "قبل كل نقلة، اسأل نفسك: ما هو تهديد خصمي؟",
        "القطعة غير المطورة هي قطعة عديمة الفائدة. طور كل قطعك.",
        "الشوكة بالحصان هي أحد أقوى التكتيكات. ابحث عنها دائماً.",
        "في نهاية اللعبة، نشاط الملك قد يكون أهم من المواد.",
        "لا تقم بحركات بيادق عشوائية، فكل حركة بيدق تخلق ضعفاً دائماً.",
        "القلعة تكون في أقصى قوتها على الأعمدة المفتوحة والصفوف السابعة.",
        "إذا كان لديك فيل سيء، حاول تبديله بفيل خصمك الجيد أو حصانه."
    ];

    const chessPrinciples = {
        'BLUNDER_HANGING_PIECE': { id: 'BLUNDER_HANGING_PIECE', name: 'خطأ فادح - قطعة متروكة', priority: 100, description: 'لقد تركت إحدى قطعك القيمة بدون حماية كافية، ويمكن للخصم أخذها الآن. هذا هو أسوأ أنواع الأخطاء لأنه يغير نتيجة المباراة فورًا.', check: (m, g) => isPieceHanging(m.to, g) },
        'BLUNDER_MATE_IN_ONE': { id: 'BLUNDER_MATE_IN_ONE', name: 'خطأ فادح - تفويت كش ملك', priority: 200, description: 'كان لديك فرصة لإنهاء المباراة بكش ملك في نقلة واحدة، لكنك لم تنتبه لها! التركيز على إنهاء اللعبة هو الأولوية القصوى.', check: (m, g) => wasMateInOneAvailable(g) },
        'ENDGAME_ROOK_ON_7TH': { id: 'ENDGAME_ROOK_ON_7TH', name: 'قلعة في الصف السابع', priority: 45, description: 'وضع قلعتك في الصف السابع للخصم هو حركة استراتيجية قوية جدًا، فهي تهدد بيادقه، وتقيد حركة ملكه، وتخلق فرص هجومية حاسمة.', check: (m, g) => m.piece === 'r' && isEndgame(g) && ((m.color === 'w' && m.to.includes('7')) || (m.color === 'b' && m.to.includes('2'))) },
        'ENDGAME_ACTIVATE_KING': { id: 'ENDGAME_ACTIVATE_KING', name: 'تفعيل الملك في النهاية', priority: 40, description: 'في نهاية اللعبة، يتحول الملك من قطعة تحتاج للحماية إلى قطعة هجومية قوية. إحضاره إلى وسط الرقعة للمشاركة في القتال هو قرار صائب.', check: (m, g) => m.piece === 'k' && isEndgame(g) },
        'MISTAKE_WEAKEN_KING_PAWN_F': { id: 'MISTAKE_WEAKEN_KING_PAWN_F', name: 'إضعاف بيدق الملك (f)', priority: 30, description: 'تحريك البيدق f (f2/f7) مبكراً، خاصة قبل التبييت، يكشف ملكك بشكل خطير ويفتح أقطارًا حيوية لهجوم الخصم. تجنب هذا الخطأ الشائع.', check: (m, g) => m.piece === 'p' && m.from.includes('f') && g.history().length < 10 },
        'GOOD_IMPROVE_WORST_PIECE': { id: 'GOOD_IMPROVE_WORST_PIECE', name: 'تحسين أسوأ قطعة', priority: 25, description: 'نقلة استراتيجية عميقة. لقد حددت القطعة الأقل فاعلية لديك ونقلتها إلى مربع أفضل، مما يزيد من قوة جيشك بشكل عام.', check: (m, g) => false }, // Requires complex check
        'MISTAKE_QUEEN_TOO_EARLY': { id: 'MISTAKE_QUEEN_TOO_EARLY', name: 'إخراج الوزير مبكراً', priority: 20, description: 'إخراج الوزير في بداية اللعبة يجعله هدفاً سهلاً لقطع الخصم. هذا يجبرك على إضاعة نقلات في تحريكه ويهدي خصمك "تمبو" مجانيًا للتطوير.', check: (m, g) => m.piece === 'q' && g.history().length < 8 },
        'MISTAKE_BAD_PAWN_STRUCTURE': { id: 'MISTAKE_BAD_PAWN_STRUCTURE', name: 'إضعاف هيكل البيادق', priority: 18, description: 'هذه النقلة أدت إلى ضعف في هيكل بيادقك (مثل إنشاء بيدق معزول أو مضاعف)، مما قد يصبح هدفًا للخصم على المدى الطويل.', check: (m, g) => false }, // Requires complex check
        'MISTAKE_MOVE_SAME_PIECE': { id: 'MISTAKE_MOVE_SAME_PIECE', name: 'تحريك نفس القطعة مرتين', priority: 15, description: 'في الافتتاح، كل نقلة ثمينة. تحريك نفس القطعة مرتين يعني أنك أهملت تطوير قطعة أخرى. الهدف هو نشر كل القطع بأسرع وقت.', check: (m, g, h) => g.history().length < 10 && h.filter(hm => hm.color === m.color && hm.piece === m.piece).length > 1 },
        'MISTAKE_UNNECESSARY_PAWN_MOVE': { id: 'MISTAKE_UNNECESSARY_PAWN_MOVE', name: 'حركة بيدق غير ضرورية', priority: 12, description: 'ركز على تطوير القطع (الأحصنة والفيلة) والسيطرة على المركز بدلاً من تحريك بيادق الأجنحة (a, b, g, h) بدون داعٍ في الافتتاح.', check: (m, g) => m.piece === 'p' && g.history().length < 8 && (m.from.includes('a') || m.from.includes('h')) },
        'OPENING_CASTLE_EARLY': { id: 'OPENING_CASTLE_EARLY', name: 'التبييت المبكر', priority: 10, description: 'ممتاز! التبييت هو أهم نقلة دفاعية في الافتتاح. لقد أمنت ملكك وأدخلت قلعتك في اللعب في نقلة واحدة.', check: (m, g) => m.flags.includes('k') || m.flags.includes('q') },
        'OPENING_CENTER_CONTROL': { id: 'OPENING_CENTER_CONTROL', name: 'السيطرة على المركز', priority: 10, description: 'نقلة قوية! السيطرة على المربعات المركزية (e4, d4, e5, d5) هي مفتاح الفوز في الافتتاح لأنها تمنح قطعك أكبر قدر من الحركة والتأثير.', check: (m, g) => (m.piece === 'p' && (m.to.includes('4') || m.to.includes('5'))) && (m.to.includes('e') || m.to.includes('d')) },
        'OPENING_DEVELOP_KNIGHTS': { id: 'OPENING_DEVELOP_KNIGHTS', name: 'تطوير الأحصنة', priority: 9, description: 'تطوير مثالي. من الأفضل تطوير الأحصنة قبل الفيلة لأنها أقل تقيدًا بهيكل البيادق ويمكنها القفز فوق القطع الأخرى.', check: (m, g) => m.piece === 'n' },
        'OPENING_DEVELOP_BISHOPS': { id: 'OPENING_DEVELOP_BISHOPS', name: 'تطوير الفيلة', priority: 8, description: 'جيد جدًا. لقد طورت فيلك ووضعته في قطر مفتوح ونشط.', check: (m, g) => m.piece === 'b' },
    };
    function isEndgame(g) { return g.SQUARES.map(s => g.get(s)).filter(Boolean).length < 14; }
    function isPieceHanging(sq, g) { const p = g.get(sq); if (!p) return false; return g.isAttacked(sq, p.color === 'w' ? 'b' : 'w'); }
    function wasMateInOneAvailable(gameBeforeMove) {
        const moves = gameBeforeMove.moves();
        for (let i = 0; i < moves.length; i++) {
            gameBeforeMove.move(moves[i]);
            if (gameBeforeMove.in_checkmate()) {
                gameBeforeMove.undo();
                return true;
            }
            gameBeforeMove.undo();
        }
        return false;
    }

    // ==========================================================================
    // SECTION 2: CORE GAME LOGIC - REBUILT FOR STABILITY
    // ==========================================================================
    $(document).ready(function() {
        // --- State Variables ---
        let board = null, game = new Chess(), selectedSquare = null, playerColor = 'w', thinking = false;

        // =================================================================================
        // THE NEW, ROBUST CLICK HANDLER - المحرك الجديد والمستقر لمعالجة النقر
        // This is the heart of the game's interaction, rebuilt from scratch.
        // =================================================================================
        function handleSquareClick(square) {
            // --- Step 1: Ignore clicks if it's not the player's turn to act. ---
            if (thinking || game.game_over() || game.turn() !== playerColor) {
                return;
            }

            const pieceOnSquare = game.get(square);

            // --- Step 2: Handle the second click (selecting a destination). ---
            if (selectedSquare) {
                // If the player clicks the same square again, deselect it.
                if (square === selectedSquare) {
                    selectedSquare = null;
                    removeHighlights();
                    return;
                }
                
                // If the player clicks another of their own pieces, switch selection.
                if (pieceOnSquare && pieceOnSquare.color === playerColor) {
                    selectedSquare = square;
                    removeHighlights();
                    highlightMoves(square);
                    return;
                }

                // Try to make the move from the selected square to the clicked square.
                const move = game.move({ from: selectedSquare, to: square, promotion: 'q' });
                
                // If the move is illegal, just deselect and do nothing.
                if (move === null) {
                    selectedSquare = null;
                    removeHighlights();
                    return;
                }

                // If the move IS LEGAL, complete the player's turn and trigger the computer.
                selectedSquare = null;
                removeHighlights();
                playerMoveMade(move);
                return;
            }

            // --- Step 3: Handle the first click (selecting a piece). ---
            if (pieceOnSquare && pieceOnSquare.color === playerColor) {
                selectedSquare = square;
                highlightMoves(square);
            }
        }

        // --- Game Flow Functions ---
        function playerMoveMade(move) {
            board.position(game.fen());
            updatePGN();
            updateStatus();
            analyzeAndShowFeedback(move, game.history({ verbose: true }));
            if (!game.game_over()) {
                setTimeout(triggerComputerMove, 500);
            }
        }
        
        function triggerComputerMove() {
            thinking = true;
            updateStatus();
            setTimeout(() => {
                const move = getComputerMove();
                if (move) game.move(move);
                board.position(game.fen());
                thinking = false;
                updateStatus();
                updatePGN();
            }, 250);
        }
        
        function getComputerMove() {
            const moves = game.moves({ verbose: true });
            if (moves.length === 0) return null;
            let bestMove = moves[0], bestValue = -Infinity;
            moves.forEach(m => {
                game.move(m.san);
                const v = -evaluateBoard(game);
                game.undo();
                if (v > bestValue) { bestValue = v; bestMove = m; }
            });
            return bestMove;
        }

        // --- UI and Helper Functions ---
        function highlightMoves(sq) { $(`#mainBoard .square-${sq}`).addClass('highlight-selected'); game.moves({square:sq,verbose:!0}).forEach(m => $(`#mainBoard .square-${m.to}`).addClass('highlight-legal')); }
        function removeHighlights() { $('.square-55d63').removeClass('highlight-selected highlight-legal'); }
        function updateStatus() { let s; const mc=game.turn()==='w'?'الأبيض':'الأسود'; if(game.in_checkmate())s=`انتهت اللعبة، كش ملك للفريق ${mc}.`;else if(game.in_draw())s='انتهت اللعبة، تعادل.';else{s=`دور الفريق ${mc} للعب`;if(thinking)s='المدرب الخبير يحلل...'} $('#gameStatus').html(s); }
        function updatePGN() { $('#pgn').html(game.pgn()); $('.pgn-container').scrollTop($('.pgn-container')[0].scrollHeight); }
        function evaluateBoard(g) { let t=0; g.SQUARES.forEach(s=>{const p=g.get(s);if(p)t+=getPieceValue(p.type)*(p.color==='w'?1:-1)}); return t; }
        function getPieceValue(p) { return {p:10,n:30,b:30,r:50,q:90,k:900}[p]||0; }
        function closeModal(modalId) { $(`#${modalId}`).removeClass('visible'); }
        
        function analyzeAndShowFeedback(m,h){let p=[],f=null;const g=new Chess(game.fen());g.undo();for(const k in chessPrinciples){const P=chessPrinciples[k];if(P.check(m,g,h)){p.push({...P,triggered:!0})}}p.sort((a,b)=>b.priority-a.priority);if(p.length>0){const t=p[0];if(t.id.startsWith("BLUNDER"))f={type:"blunder",title:"خطأ فادح!",icon:"🔥",moveExplanation:`النقلة ${m.san} خطيرة جدا!`,principle:t,suggestion:"دائما تحقق من سلامة قطعك."};else if(t.id.startsWith("MISTAKE"))f={type:"mistake",title:"خطأ استراتيجي",icon:"🤔",moveExplanation:`النقلة ${m.san} تخالف مبدأً هاماً.`,principle:t,suggestion:"فكر في العواقب طويلة المدى."};else f={type:"excellent",title:"نقلة ممتازة!",icon:"⭐",moveExplanation:`أحسنت! النقلة ${m.san} تتبع أفضل الممارسات.`,principle:t,suggestion:"هكذا يلعب المحترفون!"}}if(!f)f={type:"good",title:"نقلة قياسية",icon:"😊",moveExplanation:`النقلة ${m.san} منطقية ومقبولة.`,principle:{name:"لعب آمن",description:"لم ترتكب أخطاء واضحة."},suggestion:"استمر في البحث عن خطة."};showFeedbackModal(f)}
        function showFeedbackModal(f){const{type:t,title:i,icon:o,moveExplanation:n,principle:p,suggestion:s}=f;$('#modalHeader').removeClass().addClass('modal-header '+t);$('#modalIcon').text(o);$('#modalTitle').text(i);$('#moveExplanation').text(n).css('border-color',getBorderColor(t));if(p){$('#principleExplanation').html(`<strong>${p.name} (الأهمية: ${p.priority||'عالية'})</strong><p>${p.description}</p>`).css('border-color',getBorderColor(t))}else{$('#principleExplanation').text('لا توجد قاعدة مباشرة.').css('border-color','#ccc')}$('#suggestionExplanation').text(s).css('border-color',getBorderColor(t));$('#feedbackModal').addClass('visible')}
        function getBorderColor(t){return{excellent:'var(--success-color)',good:'var(--info-color)',inaccuracy:'var(--warning-color)',mistake:'var(--orange-color)',blunder:'var(--danger-color)'}[t]||'#ccc'}

        // --- Initialization ---
        function init() {
            board = Chessboard('mainBoard', {
                position: 'start',
                pieceTheme: 'img/{piece}.png',
                onSquareClick: handleSquareClick // Use the new, rebuilt handler
            });
            $(window).resize(board.resize);
            
            $('#startBtn').on('click', function() {
                const randomTip = gameTips[Math.floor(Math.random() * gameTips.length)];
                $('#tipText').text(randomTip);
                $('#tipModal').addClass('visible');
            });
            $('#closeTipModalBtn').on('click', function() {
                closeModal('tipModal');
                game.reset(); board.start(); updateStatus(); $('#pgn').html('');
                selectedSquare = null; removeHighlights(); thinking = false;
            });
            $('#undoBtn').on('click', function() {
                if(thinking) return;
                game.undo(); game.undo(); board.position(game.fen());
                updateStatus(); updatePGN(); selectedSquare = null; removeHighlights();
            });
            $('#closeModalBtn').on('click', () => closeModal('feedbackModal'));

            // Initial setup
            updateStatus();
        }

        init(); // Start the application
    });
    </script>
</body>
</html>
